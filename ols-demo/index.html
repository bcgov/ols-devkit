<!DOCTYPE html>
<html lang="en">

<head>
	<title>DataBC Location Services in Action</title>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
		integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" type="text/css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" type="text/css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet.locatecontrol/0.60.0/L.Control.Locate.min.css" type="text/css" />
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/themes/smoothness/jquery-ui.css" type="text/css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.css" type="text/css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.Default.css" type="text/css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/timepicker@1.11.12/jquery.timepicker.css" type="text/css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tag-it@2.0.0/css/jquery.tagit.css" type="text/css" />
	<style>
		/* make the map fullscreen */
		html, body {
            height: 100%;
            width: 100%;
        }
		body {
            padding: 0;
            margin: 0;
		}
		#container {
			height: 100%;
            width: 100%;
			overflow: hidden;
		}
		#map {
			height: 100%;
            width: 100%;
        }
		/* Slideable Sidebar */
		#tabWrapper {
			position: absolute;
			top: 0;
			left: 0;
			display: flex;
			align-items: center;
			height: 100%;
			z-index: 1000;
		}
		#tabs {
			height: 100%;
			width: 425px;
			background-color: transparent;
			display: flex;
			flex-direction: column;
			flex-wrap: nowrap;
		}
		#hideButton {
			border-color: lightSlateGrey;
			border-left: none;
			border-top-left-radius: 0;
			border-bottom-left-radius: 0;
			padding-left: 6px;
			padding-right: 6px;
		}
		.nav-tabs {
			flex: 0 0 auto;
			border-bottom-color: lightSlateGrey;
			display: flex;
			flex-wrap: wrap-reverse;
		}
		.nav-tabs > li > a {
			padding: 6px 8px 5px 8px;
			background-color: white;
			border-top: 1px solid lightgrey;
			border-right: 1px solid lightgrey;
			border-left: 1px solid lightgrey;
			border-bottom-color: lightSlateGrey;
		}
		.nav-tabs > li.active > a,
		.nav-tabs > li.active > a:hover,
		.nav-tabs > li.active > a:focus {
			border: 1px solid lightSlateGrey;
			border-bottom-color: transparent;
			cursor: default;
		}
		.nav-tabs > li > a:hover {
			border-color: LightSteelBlue ;
			border-bottom-color: lightSlateGrey;
		}
		.tab-content {
			background-color: white;
			border-right: 1px solid lightSlateGrey;
			flex: 1 1 1px;
			overflow: hidden;
		}
		.tab-pane {
			padding: 10px;
			height: 100%;
		}
		.tag-input-group {
			vertical-align: top;
		}
		.tagit {
			list-style-type: none;
		}
		.ui-front {
			z-index: 1001;
		}
		.ui-widget input {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
			font-size: 14px;
		}
		.popup-title {
			font-size: 1.2em;
			font-weight: bold;
		}
		.btn {
			padding-left: 6px;
			padding-right: 6px;
		}
		.glyphicon {
			font-size: 16px;
		}
		.form-group {
    		margin-bottom: 5px;
		}
		table.popup-table tr td {
			padding: 2px;
			border: 1px solid lightgrey;
			border-collapse: collapse;
		}
		/*table.popup-table tr td.break {
			word-wrap: break-word;
		}*/
		table.popup-table tr td.rowName {
			font-weight: bold;
		}
		.gnsLabel {
			white-space: nowrap;
			/*-webkit-text-stroke: 0.25px white;*/
			font-face: verdana;
			font-weight: bolder;
			font-size: 16px;
			text-shadow:
   				-1px -1px 0 #FFF,
    			1px -1px 0 #FFF,
    			-1px 1px 0 #FFF,
     			1px 1px 0 #FFF;
		}
		.segIdOuter {
			text-align: center;
		}
		.segId {
			padding: 1px;
			border: 1px solid black;
			border-radius: 3px;
			background-color: white;
			font-family: sans-serif;
			margin: auto;
		}
		img.navImg {
			position: absolute;
			top: 0px;
			left: 0px;
		}
		#adminAreaInfo {
		  margin: 1em 0;
		}
		#title {
			position: absolute;
			z-index: 999;
			top: 0px;
			left: 50%;
      transform: translate(-50%,0);
			border: 1px solid lightSlateGrey;
			border-top: none;
			background-color: white;
			border-radius: 0 0 4px 4px;
			padding: 4px 8px 4px 8px;
			font-family: Verdana, Arial, Helvetica, sans-serif;
			font-size: 1.2em;
			font-weight: bold;
			color: #445566;
		}
		#routerWrapper {
			display: flex;
			flex-direction: column;
			flex-wrap: nowrap;
			height: 100%;
		}
		#routerList {
			flex: 0 0 auto;
			overflow-y: scroll;
			border: 1px solid LightSteelBlue;
			border-radius: 4px 0px 0px 4px;
			padding: 2px;
			max-height: 35%;
			margin-bottom: 4px;
		}
		button.reorder {
			cursor: n-resize;
		}
		#routerControls {
			flex: 0 0 auto;
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			justify-content: space-between;
			align-items: flex-start;
		}
		.routerControl {
			margin-top: 4px;
			padding: 6px;
			border: 1px solid #CCCCCC;
			border-radius: 4px;
		}
		#time {
			width: 60px;
		}
		#date {
			width: 80px;
		}
		.notification {
			padding: 5px;
			margin: 2px;
			border: 1px solid #ffff99;
			background-color: #ffffdd;
		}
		#directions {
			overflow-y: scroll;
		}
		.direction {
			padding: 5px;
			margin: 2px;
			border: 1px solid #aaffaa;
			background-color: #eeffee;
			display: flex;
			flex-direction: row;
			flex-wrap: nowrap;
			justify-content: space-between;
			align-items: flex-start;
		}
		.selectedDirection {
			background-color: #aaccff;
			border-color: #3388ff
		}
		.direction .dirBody {
			flex: 1 1 auto;
		}
		.direction .FERRY {
			flex: 0 0 auto;
			background: url('img/ferry.png');
			background-repeat: no-repeat;
			width: 22px;
			height: 22px;
			margin: 2px;
		}
		.timing {
			margin-top: 8px;
			margin-bottom: 8px;
		}
		span.fastest {
			color: #FF00FF;
		}
		span.shortest {
			color: #0000FF;
		}
		.form-row {
			display: flex;
			flex-direction: row;
			align-items: baseline;
		}
		.short-field {
			width: 60px;
		}
		.miniBtn {
			padding: 1px 2px;
		}
		table.schedule {
			margin: auto;
		}
		table.schedule tr td {
			border: 1px solid black;
			border-collapse: collapse;
			padding: 4px;
		}
		#configDialog div {
			padding-bottom: 5px;
		}
		#configDialog td, #configDialog th {
			border: 1px solid darkGrey;
		}
		#configDialog input {
			width: 50px;
			font-size: 1em;
		}
		#configDialog input:invalid {
			border: 2px dashed red;
			background-image: linear-gradient(to right, white, pink);
		}
		#configDialog td, #configDialog th {
			padding: 1px 2px;
			text-align: center;
			font-size: 0.8em;
		}
		#configDialog table th:first-child {
			width: 110px;
		}
		.leaflet-marker-icon .number{
			position: relative;
			top: -36px;
			font-size: 11px;
			font-family: "Arial Narrow", Arial, sans-serif;
			font-weight: bold;
			width: 25px;
			text-align: center;
		}

		/* For leaflet-zoom-min.js */
		.leaflet-control-zoom-min {
			text-indent: -999em;
			background: #fff url(data:image/gif;base64,R0lGODlhGAAYAOZdACIiIiMjIy8vLyoqKsPDwzMzM0xMTDQ0NGlpaUtLS+Tk5J2dnXd3d7m5ueDg4GdnZykpKSYmJkpKSre3t09PT5eXl4KCgrCwsHNzc1lZWWhoaCcnJ5ubm3R0dFJSUp+fn1RUVJqamoODg8TExD09PYqKijo6OpGRkV1dXVFRUUNDQ3FxcZmZmYCAgEVFRXV1dSgoKIaGhlxcXEdHR5SUlMvLy5iYmNXV1VNTU7GxsbOzs9ra2jExMdbW1isrKywsLFtbW6qqqnh4eGpqat3d3XBwcI2NjWRkZLi4uL+/vyUlJZycnNvb297e3r6+vvf392VlZcbGxq2trWFhYWZmZszMzE5OTsDAwG1tbZWVlZaWlqGhod/f3////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAF0ALAAAAAAYABgAQAf/gF2Cg10KLFASAgISVBWEhFkAklaPlT0Rkpk2XRCZnj4oEwQknp4Dgw0BAFqPLZ0ZFJ4BDYICpSWEURNBpZ4Cgx+qvQAmgjs4AAEflV1XBckgShkJEQeeBUmPLwAezF0jKTqDGJkdXQaZLt5dTj/DCRq9MDldHgAbw5kPhdb5AAkXBpXAd0ABMyED8g1gsE6QAwwJhw3oQMQbB1UyRlSpQeDJAiClAoQg5OCZkUrPAGzpImJIpgJNBHWKIMUbF0FMGsTIdOpBphUNb5jo9cBWJgveLOQTgM6TihOCjkgq4s9AiGEUHFyoMMUfAA5dGHjFooEHDQSkMjEUREBYPiSDHEQkI1CJQL9SM5aAkHSAbsMuCxAYUGQAwQJvgQAAOw==) no-repeat scroll center center;
			background-size: 12px 12px;
		}
		.leaflet-control-zoom-min:focus {
			outline: 0;
		}
		.leaflet-control-zoom-min.leaflet-disabled {
			background-image: url(data:image/gif;base64,R0lGODlhGAAYAOZGAHp6eoWFhX9/f3t7e4KCgtvb2319faSkpJSUlMTExOzs7JiYmO/v79DQ0KWlpdXV1ZeXl8LCwq2trZWVldTU1KysrJOTk8HBwbS0tLW1tZ2dnaOjo5ubm9nZ2aurq+bm5oCAgMPDw+vr6+np6ZKSkomJicXFxYuLi9zc3Lm5ub+/v+Dg4J6enszMzMDAwN3d3djY2Pr6+oODg46OjqCgoHx8fJGRkaqqqr29vaampqenp7a2to+Pj7Ozs7u7u9HR0aKioqmpqX5+fs7OzsfHx66urv///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAEYALAAAAAAYABgAQAf/gEaCg0YMERskBAQkGxeEhCoAkhOPlR8GkpmOApmdICwUBSednQKDDwMALo89nBwTnQMPggSkKYQvFC2knQSDJqm8ACWCIwsAAyaVRh0ByAs1HBYGzpkBHY8VABDLRigQP4MemRVGCJk83UYwIMIWB7xCDUYQAJjCkgeF1fgW84IpMAVgsKwIJ2ECJKgTpMDDQV4CKojoFiKVBhQrVhSIkUADqQERCClw5qNSNSJGMuSwNtEIJwNDuiko9mBHJlPwJN1Y+KEErwO1MmHohgEfgXOdZuAQBERSEHwAEEQQNkFBgws0oAIIYUSCVh0HZKhwMCqTQkEFguGjMCgDsgKVFwrw62QjwTEAAeAuNJLAAQJFCBwk6BYIADs=);
		}

		/* For leaflet-history.js */
		.history-control.leaflet-bar.hidden{display:none}
		.history-control.leaflet-bar.horizontal a{display:inline-block;border-bottom:0;border-radius:0;border-right:1px solid #ccc}
		.history-control.leaflet-bar.horizontal a:first-child{border-top-left-radius:4px;border-bottom-left-radius:4px}
		.history-control.leaflet-bar.horizontal a:last-child{border-top-right-radius:4px;border-bottom-right-radius:4px;border-right:0}
		.history-control.leaflet-bar a{width:auto;font-size:1.1em;min-width:26px}
	</style>
</head>

<body>
	<div id="container">
		<div id="title">DataBC Location Services in Action</div>
		<div id="tabWrapper">
			<div id="tabs">
				<ul class="nav nav-tabs" role="tablist">
					<li role="presentation" class="active">
						<a href="#tabs-1" aria-controls="tabs-1" role="tab" data-toggle="tab">Address</a>
					</li>
					<li role="presentation">
						<a href="#tabs-2" aria-controls="tabs-2" role="tab" data-toggle="tab">Route</a>
					</li>
					<li role="presentation">
						<a href="#tabs-3" aria-controls="tabs-3" role="tab" data-toggle="tab">Businesses by Tag</a>
					</li>
					<li role="presentation">
						<a href="#tabs-4" aria-controls="tabs-4" role="tab" data-toggle="tab">Businesses by Name</a>
					</li>
					<!-- li role="presentation">
						<a href="#tabs-5" aria-controls="tabs-5" role="tab" data-toggle="tab">Isochrones</a>
					</li -->
				</ul>
				<div class="tab-content">
					<div role="tabpanel" class="tab-pane active" id="tabs-1"><form autocomplete="off">
						<div class="input-group">
							<input type="text" class="form-control input-field" id="geocodeField" placeholder="Enter civic or intersection address"/>
							<div class="input-group-btn">
								<button id="geocodeBtn" class="btn btn-default" type="button" title="Search">
									<span class="glyphicon glyphicon-search" aria-label="Search"></span>
								</button>
								<button id="randomBtn" class="btn btn-default" type="button" title="Jump at Random">
									<span class="glyphicon glyphicon-asterisk" aria-label="Random"></span>
								</button>
								<button id="gmapsBtn" class="btn btn-default" type="button" title="View in Google Maps">
									<span class="glyphicon glyphicon-globe" aria-label="View in Google Maps"></span>
								</button>
								<button id="listBtn" class="btn btn-default" type="button" title="View As List">
									<span class="glyphicon glyphicon-list" aria-label="View As List"></span>
								</button>
								<button id="addressClear" class="btn btn-default input-clear" type="button" title="Clear">
									<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
								</button>
							</div>
						</div>
						</form>
						<div>
							<h4>Examples:</h4>
							<ul>
	   						<li>1175 Douglas St Victoria BC</li>
	   						<li>201A 1175 Douglas St Victoria BC</li>
	   						<li>Victoria BC</li>
	   						<li>Douglas St and Yates St Victoria BC</li>
	   						<li>Delta Port Entrance -- Roberts Bank Rd Delta BC</li>
	   						<li>Delta Creek Bridge --  Terrace BC</li>
	   						<li>Boston Bar 8 near Boston Bar BC</li>
	   						<li>Brentwood Bay in Central Saanich BC</li>
	   						<li>Fairfield in Victoria BC</li>
	   						<li>Hwy 1 and Exit 366</li>
							</ul>
		 				</div>
						<div id="adminAreaInfo">
						</div>
					</div>
					<div role="tabpanel" class="tab-pane" id="tabs-2">
						<div id="routerWrapper">
							<div id="routerList">
								<div class="form-group">
									<div class="input-group">
										<div class="input-group-btn">
											<button class="btn btn-default reorder" type="button" title="Drag to Re-order">
												<span class="glyphicon glyphicon-sort" aria-label="Drag to Re-order"></span>
											</button>
										</div>
										<form autocomplete="off"><input type="text" class="form-control input-field" placeholder="Address" autocomplete="off"/></form>
										<div class="input-group-btn">
											<button class="btn btn-default random" type="button" title="Jump at Random">
												<span class="glyphicon glyphicon-asterisk" aria-label="Random"></span>
											</button>
											<!-- button class="btn btn-default gmaps" type="button" title="View in Google Maps">
												<span class="glyphicon glyphicon-globe" aria-label="View in Google Maps"></span>
											</button -->
											<button class="btn btn-default zoom-to" type="button" title="Zoom To Location">
												<span class="glyphicon glyphicon-map-marker" aria-label="Zoom To Location"></span>
											</button>
											<button class="btn btn-default input-clear" type="button" title="Clear">
												<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
											</button>
										</div>
									</div>
								</div>
								<div class="form-group">
									<div class="input-group">
										<div class="input-group-btn">
											<button class="btn btn-default reorder" type="button" title="Drag to Re-order">
												<span class="glyphicon glyphicon-sort" aria-label="Drag to Re-order"></span>
											</button>
										</div>
										<form autocomplete="off"><input type="text" class="form-control input-field" placeholder="Address" /></form>
										<div class="input-group-btn">
											<button class="btn btn-default random" type="button" title="Jump at Random">
												<span class="glyphicon glyphicon-asterisk" aria-label="Random"></span>
											</button>
											<!--button class="btn btn-default gmaps" type="button" title="View in Google Maps">
												<span class="glyphicon glyphicon-globe" aria-label="View in Google Maps"></span>
											</button -->
											<button class="btn btn-default zoom-to" type="button" title="Zoom To Location">
												<span class="glyphicon glyphicon-map-marker" aria-label="Zoom To Location"></span>
											</button>
											<button class="btn btn-default input-clear" type="button" title="Clear">
												<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
											</button>
										</div>
									</div>
								</div>
							</div>
							<div class="input-group">
								<div class="input-group-btn">
									<button id="addDestBtn" class="btn btn-default" type="button" title="Add Destination">
										<span class="glyphicon glyphicon-plus" aria-label="Add Destination"></span>
									</button>
								</div>
								<input id="addAddrField" type="text" class="form-control input-field" placeholder="Click on Map For Coordinates" readonly/>
								<div class="input-group-btn">
									<button class="copyToClipboardBtn btn btn-default" type="button" title="Copy to clipboard" data-clipboard-target="#addAddrField">
										<span class="glyphicon glyphicon-copy" aria-label="Copy to clipboard"></span>
									</button>
									<button class="btn btn-default input-clear" type="button" title="Clear">
										<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
									</button>
								</div>
							</div>
							<div id="routerControls">
								<div class="routerControl">
									<input name="criteria" type="radio" value="fastest" aria-label="Fastest"  checked="checked"> <span class="fastest">Fastest</span><br>
									<input name="criteria" type="radio" value="shortest" aria-label="Shortest"> <span class="shortest">Shortest</span>
								</div>
								<div class="routerControl">
									<input id="roundTripChk" type="checkbox" aria-label="Round trip" title="Round trip"> Round Trip<br/>
									<input id="optimizeChk" type="checkbox" aria-label="Optimize Order" title="Optimize Order"> Optimize Order<br/>
									<input id="nearestStopChk" type="checkbox" aria-label="Nearest Stop" title="Nearest Stop"> Nearest Stop
								</div>
								<div class="routerControl">
									<input id="ferrySchedulesChk" class="routeOnChange" type="checkbox" aria-label="Ferry Schedules" title="Ferry Schedules"> Ferry Schedules<br/>
									<input id="trafficChk" class="routeOnChange" type="checkbox" aria-label="Traffic" title="Traffic"> Traffic<br/>
									<input id="eventsChk" class="routeOnChange" type="checkbox" aria-label="Events" title="Events"> Events<br/>
									<input id="gdfChk" class="routeOnChange" type="checkbox" aria-label="Global Distortion Field" title="Global Distortion Field"> <a class="configDialogLink">Global Distortion Field</a><br/>
									<input id="ldfChk" class="routeOnChange" type="checkbox" aria-label="Local Distortion Field" title="Local Distortion Field"> Local Distortion Field<br/>
									<input id="timeDependentChk" class="routeOnChange" type="checkbox" aria-label="Time Dependent" title="Time Dependent"> Time Dependent<br/>
									<input id="turnRestrictionsChk" class="routeOnChange" type="checkbox" aria-label="Turn Restrictions" title="Turn Restrictions"> Turn Restrictions<br/>
									<input id="xingCostsChk" class="routeOnChange" type="checkbox" aria-label="Crossing Costs" title="Crossing Costs"> <a class="configDialogLink">Crossing Costs</a><br/>
									<input id="turnCostsChk" class="routeOnChange" type="checkbox" aria-label="Turn Costs" title="Turn Costs"> <a class="configDialogLink">Turn Costs</a><br/>
								</div>
								<div class="routerControl">
									Start Date/Time:
									<input id="date" class="routeOnChange" aria-label="Date" title="Date">
									<input id="time" class="routeOnChange" aria-label="Time" title="Time">
								</div>
								<div class="routerControl">
									<input id="correctSideChk" class="routeOnChange" type="checkbox" aria-label="Correct Side" title="Correct Side"> Correct Side<br/>
								</div>
							</div>
							<div class="routerControl">
								<input id="truckControlsChk" class="routeOnChange" type="checkbox" aria-label="Truck Mode" title="Truck Mode"> Truck Mode</br>
								<div id="truckControls">
									<input id="followTruckRouteChk" class="routeOnChange" type="checkbox" aria-label="Follow Truck Route" title="Follow Truck Route"> Follow Truck Route</br>
									<table>
										<tbody>
											<tr><td>Truck Route Multiplier:</td><td><input id="truckRouteMultiplier" class="routeOnChange" type="text" aria-label="Truck Route Multiplier" title="Truck Route Multiplier"></td></tr>
											<tr><td>Height OAH (m):</td><td><input id="height" class="routeOnChange" type="text" aria-label="Height" title="Height"></td></tr>
											<tr><td>Width OAW (m):</td><td><input id="width" class="routeOnChange" type="text" aria-label="Width" title="Width"></td></tr>
											<tr><td>Length OAL (m):</td><td><input id="length" class="routeOnChange" type="text" aria-label="Length" title="Length"></td></tr>
											<tr><td>Weight GVW (kg):</td><td><input id="weight" class="routeOnChange" type="text" aria-label="Weight" title="Weight"></td></tr>
										</tbody>
									</table>
								</div>
							</div>
							<div id="routerInfo">
								<div id="timing" class="timing"></div>
							</div>
							<div id="notifications"></div>
							<div id="directionsHeader"></div>
							<div id="directions"></div>
						</div>
					<form autocomplete="off"></div>
					<div role="tabpanel" class="tab-pane" id="tabs-3">
						<div class="input-group">
							<ul id="tags"></ul>
							<div class="input-group-btn tag-input-group">
								<button id="findOccsByTag" class="btn btn-default" type="button" title="Search">
									<span class="glyphicon glyphicon-search" aria-label="Search"></span>
								</button>
								<button id="clearTags" class="btn btn-default" type="button" title="Clear">
									<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
								</button>
							</div>
						</div>
						Example: First Nations <span style="font-size: 1.2em;">&crarr;</span>
					</div>
					<div role="tabpanel" class="tab-pane" id="tabs-4" autocomplete="off">
						<div class="input-group">
							<input type="text" class="form-control input-field" id="nameField" placeholder="Enter name of public place or business" />
							<div class="input-group-btn">
								<button id="findOccsByName" class="btn btn-default" type="button" title="Search">
									<span class="glyphicon glyphicon-search" aria-label="Search"></span>
								</button>
								<button id="nameClear" class="btn btn-default input-clear" type="button" title="Clear">
									<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
								</button>
							</div>
						</div>
					</div>
					<div role="tabpanel" class="tab-pane" id="tabs-5">
						<div class="form-group input-group">
							<input type="text" class="form-control input-field" id="isoGeocodeField" placeholder="Enter civic or intersection address" />
							<div class="input-group-btn">
								<button id="isoRandom" class="btn btn-default" type="button" title="Jump at Random">
									<span class="glyphicon glyphicon-asterisk" aria-label="Random"></span>
								</button>
								<button id="isoClear" class="btn btn-default input-clear" type="button" title="Clear">
									<span class="glyphicon glyphicon-remove" aria-label="Clear"></span>
								</button>
							</div>
						</div>
						<div class="form-group form-row">
							<label for="zoneSize" class="col-sm-5 col-form-label">Zone Size (minutes):</label>
							<div class="col-sm-3">
								<input type="text" class="form-control" id="zoneSize" value="10" />
							</div>
						</div>
						<div class="form-group form-row">
							<label for="zoneSize" class="col-sm-5 col-form-label">Zone Count:</label>
							<div class="col-sm-3">
								<input type="text" class="form-control" id="zoneCount" value="1" />
							</div>
						</div>
						<div class="form-group form-row">
							<label for="inboundChk" class="col-sm-5 col-form-label">Inbound?</label>
							<div class="col-sm-3">
								<input id="inboundChk" type="checkbox" aria-label="Inbound" title="Inbound">
							</div>
						</div>
						<div class="form-group form-row">
							<label for="testChk" class="col-sm-5 col-form-label">Test</label>
							<div class="col-sm-3">
								<input id="testChk" type="checkbox" aria-label="Test" title="Test">
							</div>
						</div>

					</div>
				</div>
			</div>
			<div id="hideHandle">
				<button id="hideButton" type="button" class="btn btn-default" title="Collapse side panel">
					<span class="glyphicon glyphicon-chevron-left" aria-label="Clear"></span>
				</button>
			</div>
		</div> <!-- tabWrapper -->
		<div id="map"></div>
	</div> <!-- container -->
	<div id="configDialog" title="Configuration">
		<div>
		<div>
			<table>
			  <thead>
				  <tr><th></th><th>yield/<br/>roundabout</th><th>sign</th><th>light</th><th>multiplier</th></tr>
			  </thead>
			  <tbody>
  				<tr>
	  				<th>Crossing Cost</th>
		  			<td><input id="yieldCost" class="routeOnChange" required type="number" min="0" max="100" step="any"></td>
			  		<td><input id="signCost" class="routeOnChange" required type="number" min="0" max="100" step="any"></td>
				  	<td><input id="lightCost" class="routeOnChange" required type="number" min="0" max="100" step="any"></td>
					  <td><input id="multiplier" class="routeOnChange" required type="number" min="1" max="10" step="any"></td>
  				</tr>
	  		</tbody>
		  </table>
		</div>
		<div>
			<table>
			  <thead>
				  <tr><th></th><th>left</th><th>right</th><th>leftTruck</th><th>rightTruck</th></tr>
			  </thead>
			  <tbody>
  				<tr>
	  				<th>Turn Cost</th>
		  			<td><input id="leftTurnCost" class="routeOnChange" required type="number" min="0" max="100" step="any"></td>
			  		<td><input id="rightTurnCost" class="routeOnChange" required type="number" min="0" max="100" step="any"></td>
				  	<td><input id="leftTruckTurnCost" class="routeOnChange" required type="number" min="0" max="100" step="any"></td>
					  <td><input id="rightTruckTurnCost" class="routeOnChange" required type="number" min="0" max="100" step="any"></td>
  				</tr>
	  		</tbody>
		  </table>
		</div>
		<div>
			Global Distortion Field
			<table id="gdfTable">
				<thead>
					<tr><th rowspan="2">Road Class</th><th colspan="2">Friction Factor</th></tr>
					<tr><th>Base</th><th>TruckRoute</th></tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		<div>
			Tuning String:<input id="configString">
			<button class="copyToClipboardBtn" type="button" title="Copy to clipboard" data-clipboard-target="#configString">
				<span class="glyphicon glyphicon-copy" aria-label="Copy to clipboard"></span>
			</button>
		</div>
	</div>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCO2a43ItOYdAuRFcbCSLLn8AQwnMlf6sI"></script>
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
	<script src='https://unpkg.com/leaflet.gridlayer.googlemutant@0.11.2/dist/Leaflet.GoogleMutant.js'></script>
	<script src="https://cdn.jsdelivr.net/leaflet.locatecontrol/0.60.0/L.Control.Locate.min.js"></script>
	<script src="https://unpkg.com/esri-leaflet@2.1.4/dist/esri-leaflet.js"
		integrity="sha512-m+BZ3OSlzGdYLqUBZt3u6eA0sH+Txdmq7cqA1u8/B2aTXviGMMLOfrKyiIW7181jbzZAY0u+3jWoiL61iLcTKQ=="
		crossorigin=""></script>
	<script src="leaflet-bing-layer.js"></script>
	<!--script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script-->
	<!--script src="https://unpkg.com/leaflet.featuregroup.subgroup@1.0.2/dist/leaflet.featuregroup.subgroup.js"></script-->
	<!--script src="https://unpkg.com/leaflet.markercluster@1.0.6/dist/leaflet.markercluster.js"></script-->
	<!--script src="https://unpkg.com/leaflet.markercluster.freezable@0.1.1/dist/leaflet.markercluster.freezable.js"></script-->
	<script src="leaflet.rotatedMarker.js"></script>
	<script src="leaflet-layerjson.js"></script>
	<script src="leaflet-history.js"></script>
	<script src="leaflet-zoom-min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/timepicker@1.11.12/jquery.timepicker.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/tag-it@2.0.0/js/tag-it.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"
		integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"></script>
	<script type="text/javascript" src="https://unpkg.com/clipboard@2.0.0/dist/clipboard.min.js"></script>
	<script>
		L.NumberedIcon = L.Icon.extend({
			options: {
    			number: '',
				iconUrl: 'img/marker-icon-hole.png',
    			iconSize: new L.Point(25, 41),
				iconAnchor: new L.Point(13, 41),
				popupAnchor: new L.Point(0, -33),
				shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
				shadowSize: [41, 41]
			},

			createIcon: function () {
				var div = document.createElement('div');
				var img = this._createImg(this.options['iconUrl']);
				var numdiv = document.createElement('div');
				numdiv.setAttribute ( "class", "number" );
				numdiv.innerHTML = this.options['number'] || '';
				div.appendChild ( img );
				div.appendChild ( numdiv );
				this._setIconStyles(div, 'icon');
				return div;
			},

		});

		// parse query params
		var queryParams = {};
		location.search.substr(1).split("&").forEach(function(item) {
			var s = item.split("="), k = s[0], v = s[1] && decodeURIComponent(s[1]);
			queryParams[k] = v;
		});

		var BING_KEY = 'ArFQcMQQdw-tWyNSzt5Mafl-kq4I6naIWvX7YZjq-P20-f-txYOcMzPnl0yoNvvn';

		// API URLs
		var DATABC_APIKEY = "11dd756f680c47b5aef5093d95543738";
		var gcApi = "https://geocoder.api.gov.bc.ca/";
		var routeApi = "https://router.api.gov.bc.ca/";
		var routeMethod = 'POST';
		//var routeMethod = 'GET';
		switch(queryParams['gc']) {
			case 'tst':
				gcApi = "https://geocodertst.api.gov.bc.ca/";
				break;
		  	case 'dlv':
			  	gcApi = "https://geocoderdlv.api.gov.bc.ca/";
				break;
			case 'rri':
				gcApi = "https://ssl.refractions.net/ols/pub/geocoder/";
				break
			case 'local':
				gcApi = "http://localhost:8080/pub/geocoder/";
				break;
			case 'dip':
				gcApi = "https://data-integration-geocoder-prod.apps.silver.devops.gov.bc.ca/";
		}

		switch(queryParams['rt']) {
			case 'tst':
				routeApi = "https://routertst.api.gov.bc.ca/";
				break;
			case 'dlv':
				routeApi = "https://routerdlv.api.gov.bc.ca/";
				break;
		 	case 'rri':
				routeApi = "https://ssl.refractions.net/ols/router/";
				break;
			case 'dev':
				routeApi = "http:///192.168.50.126:8080/pub/router/";
				break
			case 'local':
				routeApi = "http://localhost:8080/pub/router/";
				break;
			case 'dip':
				routeApi = "https://data-integration-router-api-prod.apps.silver.devops.gov.bc.ca/";
				break;
			default:
				routeMethod = 'GET';
		}

		var routeHeaders = {apiKey: DATABC_APIKEY};
		var routeQuery = '';
		if(routeMethod == 'GET') {
			routeHeaders = {};
			routeQuery = 'apikey=' + DATABC_APIKEY
		}

		var xmdx = 5000;
		if(queryParams['xmdx']) {
			var num = parseInt(queryParams['xmdx']);
			if(!isNaN(num)) {
				xmdx = num;
			}
		}

		var matchPrecisionNot = "";
		if('noStreets' in queryParams) {
			matchPrecisionNot = "street";
		}

		// Leaflet Map setup
		var map = L.map('map', {
			minZoom: 4,
			maxZoom: 20,
			zoomControl: false
		}).setView([48.44, -123.43], 12);
		L.control.scale({position:'bottomright'}).addTo(map);
		new L.HistoryControl({
			position: 'bottomright',
    		backImage: 'glyphicon glyphicon-triangle-left',
    		forwardImage: 'glyphicon glyphicon-triangle-right'
		}).addTo(map);
		map.addControl(new L.Control.ZoomMin({
			position: 'bottomright',
			minBounds: [
				[48.3, -139.06],
				[60.0, -114.03]
			]
		}));
		L.control.locate({
			position: 'bottomright',
			icon: 'glyphicon glyphicon-map-marker',
			iconLoading: 'glyphicon glyphicon-time',
			locateOptions: {
				maxZoom: 16
			}
		}).addTo(map);

		map.createPane('routePane');
		map.getPane('routePane').style.zIndex = 499;

		// var mcg = L.markerClusterGroup({
		// 	showCoverageOnHover: false,
		// 	zoomToBoundsOnClick: false,
		// 	removeOutsideVisibleBouncds: false,
		// 	maxClusterRadius: 10
		// });
		// mcg.addTo(map);
		// mcg.freezeAtZoom("maxKeepSpiderfy");

		// var clusterManager = {
		// 	layers: [],
		// 	mcg: mcg,
		// 	addLayer: function(layer) {
		// 		this.layers.push(layer);
		// 	},
		// 	clearLayer: function(layer) {
		// 		// clear all the markers
		// 		this.mcg.clearLayers();
		// 		// re-add the markers from the other layers
		// 		for(var i = 0; i < this.layers.length; i++) {
		// 			if(this.layers[i] != layer) {
		// 				this.mcg.addLayers(lyr);
		// 			}
		// 		}
		// 	},
		// 	addMarker: function(marker) {
		// 		this.mcg.addLayer(marker);
		// 	}
		// };

		// var oms = new OverlappingMarkerSpiderfier(map, {nearbyDistance: 30});
		// var popup = new L.Popup();
		// oms.addListener('click', function(marker) {
		// 	popup.setContent(marker.desc);
		// 	popup.setLatLng(marker.getLatLng());
		// 	map.openPopup(popup);
		// });
		// oms.addListener('spiderfy', function(markers) {
		// 	map.closePopup();
		// });
		//
		// var omsManager = {
		// 	layers: [],
		// 	oms: oms,
		// 	addLayer: function(layer) {
		// 		this.layers.push(layer);
		// 	},
		// 	clearLayer: function(layer) {
		// 		// clear all the markers
		// 		this.oms.clearMarkers();
		// 		// re-add the markers from the other layers
		// 		for(var i = 0; i < this.layers.length; i++) {
		// 			if(this.layers[i] != layer) {
		// 				this.layers[i].eachLayer(function(lyr) {
		// 					this.oms.addMarker(lyr);
		// 				});
		// 			}
		// 		}
		// 	},
		// 	addMarker: function(marker) {
		// 		this.oms.addMarker(marker);
		// 	}
		// };

		var baseLayers = {};
		var overlays = {};

		// define icons to use for markers
		var siteIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/geocoder/parcelPoint_high.png',
			iconSize: [32,32],
			iconAnchor: [16,16],
			popupAnchor: [0,-10],
		});

		var apIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/geocoder/accessPoint_high.png',
			iconSize: [32,32],
			iconAnchor: [16,32],
			popupAnchor: [0,-32],
		});

		var intIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/geocoder/intersectionPoint_high.png',
			iconSize: [32,37],
			iconAnchor: [16,37],
			popupAnchor: [0,-32],
		});

		var occIcon = L.icon({
			iconUrl: 'https://cdn.rawgit.com/bcgov/ols-devkit/master/kml/icons/gsr/black_border_32p/bcgsr.unclassified.png',
			iconSize: [26,32],
			iconAnchor: [13,16],
			popupAnchor: [0,-16],
		});

		var redIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		});

		var greenIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41]
		});

		var navInfoIcons = {};
		navInfoIcons['IMP'] = {};
		navInfoIcons['IMP']['ROUNDABOUT'] = new L.Icon({
			iconUrl: 'img/roundabout.png',
			iconSize: [20, 21],
			iconAnchor: [10, 10]
		});
		navInfoIcons['IMP']['YIELD'] = new L.Icon({
			iconUrl: 'img/yield.png',
			iconSize: [16, 16],
			iconAnchor: [8, 8]
		});
		navInfoIcons['IMP']['STOPSIGN'] = new L.Icon({
			iconUrl: 'img/stopsign.png',
			iconSize: [16, 16],
			iconAnchor: [8, 8]
		});
		navInfoIcons['IMP']['LIGHT'] = new L.Icon({
			iconUrl: 'img/light.png',
			iconSize: [16, 16],
			iconAnchor: [8, 8]
		});
		navInfoIcons['IMP']['BARRICADE'] = new L.Icon({
			iconUrl: 'img/barricade.png',
			iconSize: [16, 16],
			iconAnchor: [8, 8]
		});
		navInfoIcons['DIR'] = new L.Icon({
			iconUrl: 'img/straight.png',
			iconSize: [16, 16],
			iconAnchor: [8, 8]
		});
		navInfoIcons['HR'] = new L.Icon({
			iconUrl: 'img/restriction.png',
			iconSize: [16, 16],
			iconAnchor: [8, 8]
		});
		navInfoIcons['EV'] = new L.Icon({
			iconUrl: 'img/cone.png',
			iconSize: [32, 32],
			iconAnchor: [12, 26]
		});
		navInfoIcons['SC'] = new L.Icon({
			iconUrl: 'img/ferry.png',
			iconSize: [22, 22],
			iconAnchor: [11, 11]
		});

		function getNavInfoIcon(props) {
			var icon;
			if(props.type == 'IMP') {
				icon = navInfoIcons[props.type][props.subType];
			} else if(props.type == 'ID') {
				icon = L.divIcon({
					className:'segIdOuter',
					html: '<span class="segId">' + props.detail + '</span>',
					iconSize: null,
					iconSize: [56, 20],
					iconAnchor: [28, 10]
				});
			} else if(props.type != 'TR') {
				icon = navInfoIcons[props.type];
			} else {
				var html = '';
				if(props.detail.indexOf('U: ALWAYS') >= 0) {
					html += '<img class="navImg" src="img/no_uturn.png">';
				} else if(props.detail.indexOf('U:') >= 0) {
					html += '<img class="navImg" src="img/no_uturn_td.png">';
				}
				if(props.detail.indexOf('L: ALWAYS') >= 0) {
					html += '<img class="navImg" src="img/no_left.png">';
				} else if(props.detail.indexOf('L:') >= 0) {
					html += '<img class="navImg" src="img/no_left_td.png">';
				}
				if(props.detail.indexOf('C: ALWAYS') >= 0) {
					html += '<img class="navImg" src="img/no_straight.png">';
				} else if(props.detail.indexOf('C:') >= 0) {
					html += '<img class="navImg" src="img/no_straight_td.png">';
				}
				if(props.detail.indexOf('R: ALWAYS') >= 0) {
					html += '<img class="navImg" src="img/no_right.png">';
				} else if(props.detail.indexOf('R:') >= 0) {
					html += '<img class="navImg" src="img/no_right_td.png">';
				}

				icon = L.divIcon({
					className:'',
					html: html,
					iconSize: [24, 20],
					iconAnchor: [12, 10]
				});
			}
			if(icon === undefined) {
				icon = L.Icon.Default;
			}
			return icon;
		}

		var baseErrorMsg = "An unexpected server error occurred; No response from server.\n";

		var mapboxStreetsLayer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY2hvZGdzb24iLCJhIjoiY2oxM3JibHM4MDF3dTJxcDhlcnd1enF5aSJ9.Z_z0AGjZf6P9oh8NWY1JqQ', {
			maxZoom: 20,
			tileSize: 512,
			zoomOffset: -1,
			attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			id: 'mapbox/streets-v11'
		});
		baseLayers['MapBox Streets'] = mapboxStreetsLayer;
		mapboxStreetsLayer.addTo(map);

		var esriStreetsLayer = L.esri.basemapLayer('Streets', {
			maxZoom: 20
		});
		baseLayers['ESRI Streets'] = esriStreetsLayer;

		var googleRoads = L.gridLayer.googleMutant({
			type: 'roadmap' // valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
		});
		baseLayers['Google Roads'] = googleRoads;

		var bingRoads = L.tileLayer.bing({
			bingMapsKey: BING_KEY,
			imagerySet: 'Road',
			maxZoom: 20
		});
		baseLayers['Bing Roads'] = bingRoads;

		var bcRoadsBaseLayer = L.tileLayer.wms('https://maps.gov.bc.ca/arcgis/services/province/roads_wm/MapServer/WmsServer?',
			{
				maxZoom: 20,
				layers: '0'
			});
		baseLayers['BC Transportation Base'] = bcRoadsBaseLayer;

		var mapboxSatlayer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY2hvZGdzb24iLCJhIjoiY2oxM3JibHM4MDF3dTJxcDhlcnd1enF5aSJ9.Z_z0AGjZf6P9oh8NWY1JqQ', {
			maxZoom: 20,
			tileSize: 512,
			zoomOffset: -1,
			attribution: 'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox/satellite-v9'
		});
		baseLayers['MapBox Satellite'] = mapboxSatlayer;

		var esriImageryLayer = L.esri.basemapLayer('Imagery', {
			maxZoom: 20
		});
		baseLayers['ESRI Imagery'] = esriImageryLayer;

		var googleSatellite = L.gridLayer.googleMutant({
			type: 'satellite' // valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
		});
		baseLayers['Google Satellite'] = googleSatellite;

		var bingAerial = L.tileLayer.bing({
			bingMapsKey: BING_KEY,
			imagerySet: 'Aerial',
			maxZoom: 20
		});
		baseLayers['Bing Aerial'] = bingAerial;

		var esriTopoLayer = L.esri.basemapLayer('Topographic', {
			maxZoom: 20
		});
		baseLayers['ESRI Topographic'] = esriTopoLayer;

		var bcTopoBaseLayer = L.tileLayer.wms('https://maps.gov.bc.ca/arcserver/services/province/web_mercator_cache/MapServer/WMSServer?',
			{
				maxZoom: 20,
				layers: '0'
			});
		baseLayers['BC Topographic Base'] = bcTopoBaseLayer;

		var trimLayer = L.tileLayer.wms('http://openmaps.gov.bc.ca/geo/pub/wms',
			{
				maxZoom: 20,
				layers: 'pub:WHSE_BASEMAPPING.TRIM_WATER_LINES,pub:WHSE_BASEMAPPING.TRIM_TRANSPORTATION_LINES,pub:WHSE_BASEMAPPING.TRIM_WATER_POINTS,pub:WHSE_BASEMAPPING.TRIM_TRANSPORTATION_POINTS,pub:WHSE_BASEMAPPING.TRIM_CONTOUR_POINTS',
				styles: '3345,3334,,3344,3333,3332',
				format: 'image/png',
				transparent: true
			});
		overlays['TRIM'] = trimLayer;

		var siteLayer = new L.layerJSON({
			url: gcApi + "sites/within.json?excludeUnits=true&brief=true&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 14,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			propertyTitle: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return siteIcon;
			},
			onEachMarker: function(feature, marker) {
				marker.bindPopup(makePopupText(feature.properties));
			}

		});
		overlays["Addresses - parcel point"] = siteLayer;

		var apLayer = new L.layerJSON({
			url: gcApi + "sites/within.json"
				+ "?excludeUnits=true&brief=true&locationDescriptor=accessPoint"
				+ "&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 14,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			propertyTitle: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return apIcon;
			},
			onEachMarker: function(feature, marker) {
				marker.bindPopup(makePopupText(feature.properties));
			}
		});
		overlays["Addresses – access point "] = apLayer;

		var occLayer = new L.layerJSON({
			url: gcApi + "occupants/within.json?brief=true&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 1,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			propertyTitle: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return occIcon;
			},
			onEachMarker: function(feature, marker) {
				marker.bindPopup(makePopupText(feature.properties));
			}
		});
		overlays["Businesses"] = occLayer;

		var intLayer = new L.layerJSON({
			url: gcApi + "intersections/within.json?brief=true&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 14,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.fullAddress",
			propertyTitle: "properties.fullAddress",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function() {
				return intIcon;
			},
			onEachMarker: function(feature, marker) {
				marker.bindPopup(makePopupText(feature.properties));
			}
		});
		overlays["Intersections"] = intLayer;

		var parcelLayer = L.tileLayer.wms('https://openmaps.gov.bc.ca/geo/pub/WHSE_CADASTRE.PMBC_PARCEL_FABRIC_POLY_SVW/ows?SERVICE=WMS&',
			{
				maxZoom: 20,
				styles: 7834,5898,
				layers: 'pub:WHSE_CADASTRE.PMBC_PARCEL_FABRIC_POLY_SVW',
				transparent: true,
				format: 'image/png'
			});
		//parcelLayer.addTo(map);
		overlays['ParcelMap BC'] = parcelLayer;

		var draLayer = L.tileLayer.wms('http://openmaps.gov.bc.ca/geo/ows?',
			{
				maxZoom: 20,
				layers: 'pub:WHSE_BASEMAPPING.DRA_DGTL_ROAD_ATLAS_MPAR_SP',
				transparent: true,
				format: 'image/png'
			});
		overlays['BC Digital Road Atlas'] = draLayer;

		// var gnsLayer = L.tileLayer.wms('http://test.openmaps.gov.bc.ca/geo/pub/WHSE_BASEMAPPING.GNS_GEOGRAPHICAL_NAMES_SP/ows?',
		// 	{
		// 		layers: 'pub:WHSE_BASEMAPPING.GNS_GEOGRAPHICAL_NAMES_SP',
		// 		transparent: true,
		// 		format: 'image/png'
		// 	});
		var gnsLayer = new L.layerJSON({
			url: "https://apps.gov.bc.ca/pub/bcgnws/names/official/inside"
				+ "?itemsPerPage=50&sortBy=name&outputFormat=json&outputSRS=4326"
				+ "&bbox={lon1},{lat1},{lon2},{lat2}",
			minZoom: 9,
			caching: false,
			propertyItems: "features",
			propertyId: "properties.uri",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function(data, title) {	// make icon from data
				return L.divIcon({html: data.properties.name, className: "gnsLabel"});
			},
			onEachMarker: function(feature, layer) {
				//layer.bindPopup(makePopupText(feature.properties));
			}
		});
		overlays['BC Geographical Names'] = gnsLayer;

		var impactorLayer = new L.layerJSON({
			//url: routeApi + "navInfo.json?types=IMP&bbox={lon1},{lat1},{lon2},{lat2}",
			callData: function(bbox, callback) {
				return jQuery.ajax({
					url: routeApi + "navInfo.json?" + routeQuery,
					headers: routeHeaders,
					data: {
						types: 'IMP',
						bbox: bbox[0][1] + ',' + bbox[0][0] + ',' + bbox[1][1] + ',' + bbox[1][0]
					},
					success: callback
				});
			},
			minZoom: 16,
			caching: false,
			propertyItems: "features",
			propertyId: null,
			propertyTitle: "properties.detail",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function(data) {
				return getNavInfoIcon(data.properties);
			},
			onEachMarker: function(feature, layer) {
				layer.options.rotationAngle = 90 - feature.properties.angle;
			}
		});
		overlays["Stop Signs/Lights/Yields/Barricades"] = impactorLayer;

		var navInfoLayer = new L.layerJSON({
			//url: routeApi + "navInfo.json?types=DIR,TR&bbox={lon1},{lat1},{lon2},{lat2}",
			callData: function(bbox, callback) {
				return jQuery.ajax({
					url: routeApi + "navInfo.json?" + routeQuery,
					headers: routeHeaders,
					data: {
						types: 'DIR,TR',
						bbox: bbox[0][1] + ',' + bbox[0][0] + ',' + bbox[1][1] + ',' + bbox[1][0]
					},
					success: callback
				});
			},
			minZoom: 16,
			caching: false,
			propertyItems: "features",
			propertyId: null,
			propertyTitle: "properties.detail",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function(data) {
				return getNavInfoIcon(data.properties);
			},
			onEachMarker: function(feature, layer) {
				layer.options.rotationAngle = 90 - feature.properties.angle;
				if(feature.properties.fromFragment) {
					layer.on('mouseover', function(ev) {
						clearTurnMarkers();
						turnMarkers.push(L.polyline(L.GeoJSON.coordsToLatLngs(feature.properties.fromFragment.coordinates), {color: 'blue'}));
						for(var i= 0, len = feature.properties.toFragments.length; i< len; i++) {
							turnMarkers.push(L.polyline(L.GeoJSON.coordsToLatLngs(feature.properties.toFragments[i].coordinates), {color: 'red'}));
						}
						for(var i = 0; i< turnMarkers.length; i++) {
							map.addLayer(turnMarkers[i]);
						}
					});
					layer.on('mouseout', clearTurnMarkers);
				}
			}
		});
		overlays["Navigation Info"] = navInfoLayer;

		var hardRestrictionLayer = new L.layerJSON({
			//url: routeApi + "navInfo.json?types=HR&bbox={lon1},{lat1},{lon2},{lat2}",
			callData: function(bbox, callback) {
				return jQuery.ajax({
					url: routeApi + "navInfo.json?" + routeQuery,
					headers: routeHeaders,
					data: {
						types: 'HR',
						bbox: bbox[0][1] + ',' + bbox[0][0] + ',' + bbox[1][1] + ',' + bbox[1][0]
					},
					success: callback
				});
			},
			minZoom: 10,
			caching: false,
			propertyItems: "features",
			propertyId: null,
			propertyTitle: "properties.detail",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function(data) {
				return getNavInfoIcon(data.properties);
			}
		});
		overlays["Hard Restrictions"] = hardRestrictionLayer;

		var eventLayer = new L.layerJSON({
			//url: routeApi + "navInfo.json?types=EV&bbox={lon1},{lat1},{lon2},{lat2}",
			callData: function(bbox, callback) {
				return jQuery.ajax({
					url: routeApi + "navInfo.json?" + routeQuery,
					headers: routeHeaders,
					data: {
						types: 'EV',
						bbox: bbox[0][1] + ',' + bbox[0][0] + ',' + bbox[1][1] + ',' + bbox[1][0]
					},
					success: callback
				});
			},
			minZoom: 4,
			caching: false,
			propertyItems: "features",
			propertyId: null,
			propertyTitle: "properties.detail",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function(data) {
				return getNavInfoIcon(data.properties);
			}
		});
		overlays["Open511 Events"] = eventLayer;

		var truckRouteLayer = new L.layerJSON({
			//url: routeApi + "navInfo.json?types=TRK&bbox={lon1},{lat1},{lon2},{lat2}",
			callData: function(bbox, callback) {
				return jQuery.ajax({
					url: routeApi + "navInfo.json?" + routeQuery,
					headers: routeHeaders,
					data: {
						types: 'TRK',
						bbox: bbox[0][1] + ',' + bbox[0][0] + ',' + bbox[1][1] + ',' + bbox[1][0]
					},
					success: callback
				});
			},
			minZoom: 10,
			caching: false,
			propertyItems: "features",
			propertyId: null,
			propertyTitle: "properties.detail",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			dataToMarker: function(data) {
				return L.GeoJSON.geometryToLayer(data,  {
						color: '#00AA00',
						lineCap: 'butt',
						weight: 2,
						dashArray: '3 3'
				});
			}
		});
		overlays["Truck Routes"] = truckRouteLayer;

		var deadEndLayer = new L.layerJSON({
			//url: routeApi + "navInfo.json?types=DE&bbox={lon1},{lat1},{lon2},{lat2}",
			callData: function(bbox, callback) {
				return jQuery.ajax({
					url: routeApi + "navInfo.json?" + routeQuery,
					headers: routeHeaders,
					data: {
						types: 'DE',
						bbox: bbox[0][1] + ',' + bbox[0][0] + ',' + bbox[1][1] + ',' + bbox[1][0]
					},
					success: callback
				});
			},
			minZoom: 10,
			caching: false,
			propertyItems: "features",
			propertyId: null,
			propertyTitle: "properties.detail",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			dataToMarker: function(data) {
				return L.GeoJSON.geometryToLayer(data,  {
						color: 'purple',
						lineCap: 'butt',
						weight: 2,
						dashArray: '3 3'
				});
			}
		});
		overlays["Dead Ends"] = deadEndLayer;

		var trafficLayer = new L.layerJSON({
			//url: routeApi + "navInfo.json?types=TF&departure={departure}&bbox={lon1},{lat1},{lon2},{lat2}",
			callData: function(bbox, callback) {
				return jQuery.ajax({
					url: routeApi + "navInfo.json?" + routeQuery,
					headers: routeHeaders,
					data: {
						types: 'TF',
						departure: date2String($('#time').timepicker('getTime', $('#date').datepicker('getDate'))),
						bbox: bbox[0][1] + ',' + bbox[0][0] + ',' + bbox[1][1] + ',' + bbox[1][0]
					},
					success: callback
				});
			},
			minZoom: 13,
			caching: false,
			propertyItems: "features",
			propertyId: null,
			propertyTitle: "properties.detail",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			dataToMarker: function(data) {
				return L.GeoJSON.geometryToLayer(data);
			},
			onEachMarker: function(feature, layer) {
				if(feature.properties.subType == "SLOWEST") {
					color = '#FF0000';
				} else if(feature.properties.subType == "SLOWER") {
					color = '#FF6600';
				} else if(feature.properties.subType == "SLOW") {
					color = '#FFAA00';
				}
				layer.setStyle({color:color, weight:4, opacity: 0.75});
			}
		});
		overlays["Traffic"] = trafficLayer;

		var ferryTerminalLayer = new L.layerJSON({
			callData: function(bbox, callback) {
				return jQuery.ajax({
					url: routeApi + "navInfo.json?" + routeQuery,
					headers: routeHeaders,
					data: {
						types: 'SC',
						departure: date2String($('#time').timepicker('getTime', $('#date').datepicker('getDate'))),
						bbox: bbox[0][1] + ',' + bbox[0][0] + ',' + bbox[1][1] + ',' + bbox[1][0]
					},
					success: callback
				});
			},
			minZoom: 4,
			caching: false,
			propertyItems: "features",
			propertyId: null,
			propertyTitle: "properties.subType",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			dataToMarker: function(data, loc) {
				if(data.geometry.type == 'Point') {
					return this._defaultDataToMarker(data, loc)
				} else {
					return L.GeoJSON.geometryToLayer(data);
				}
			},
			buildIcon: function(data) {
				return getNavInfoIcon(data.properties);
			},
			onEachMarker: function(feature, layer) {
				layer.bindPopup(feature.properties.detail);
			}
		});
		overlays["Ferry Terminals"] = ferryTerminalLayer;

		var segIdLayer = new L.layerJSON({
			//url: routeApi + "navInfo.json?types=ID&bbox={lon1},{lat1},{lon2},{lat2}",
			callData: function(bbox, callback) {
				return jQuery.ajax({
					url: routeApi + "navInfo.json?" + routeQuery,
					headers: routeHeaders,
					data: {
						types: 'ID',
						bbox: bbox[0][1] + ',' + bbox[0][0] + ',' + bbox[1][1] + ',' + bbox[1][0]
					},
					success: callback
				});
			},
			minZoom: 12,
			caching: false,
			propertyItems: "features",
			propertyId: null,
			propertyTitle: "properties.detail",
			locAsGeoJSON: true,
			propertyLoc: "geometry.coordinates",
			buildIcon: function(data) {
				return getNavInfoIcon(data.properties);
			}
		});
		overlays["Internal Segment Ids"] = segIdLayer;

		if(queryParams['test_results']) {
			addTestResults(queryParams['test_results']);
		}
		var layerControl = L.control.layers(baseLayers, overlays).addTo(map);

		// turn restriction visualition markers
		var turnMarkers = [];

		function clearTurnMarkers() {
			if(turnMarkers && turnMarkers.length > 0) {
				for(var i = 0; i< turnMarkers.length; i++) {
					map.removeLayer(turnMarkers[i]);
				}
				turnMarkers = [];
			}
		}

		// tabs UI setup
		$('#myTabs a').click(function (e) {
			e.preventDefault();
			$(this).tab('show');
		});

		// datepicker/timepicker UI setup
		$('#date').datepicker();
		$('#date').datepicker('option', 'dateFormat', "yy-mm-dd");
		$('#date').datepicker('setDate', new Date());
		$('#time').timepicker();
		$('#time').timepicker('setTime', new Date());

 		$('div.input-group').on('click', 'button.input-clear', function(evt) {
			$(this).parents('div.input-group').find('input.input-field').val('');
		});

		function makeTestResultPopupText(props) {
			let str ='<table class="popup-table">';
			Object.keys(props).forEach(function(key) {
				if(key == "partition_indices") return;
				str += '<tr><td class="rowName">' + key + ':</td><td>' + props[key] + '</td></tr>';
			});
			str += '</table>';
			return str;
		}

		function makePopupText(props) {
			var str = '<span class="popup-title">' + props.fullAddress + '</span> ';
			if(!props.occupantName) {
				str += "<button id=\"addSiteToRouteBtn\" class=\"btn btn-default miniBtn\" type=\"button\" title=\"Add Location to Route\">"
					+ "<span class=\"glyphicon glyphicon-plus\" aria-label=\"Add Location to Route\"></span>"
					+ "</button>";
			}
			if(props.localityType || props.score || props.degree || props.occupantName) {
				str +='<table class="popup-table">';

				if(props.localityType) {
					str += '<tr><td class="rowName">Locality Type:</td><td>' + props.localityType + '</td></tr>';
					str += '<tr><td class="rowName">Electoral Area:</td><td>' + props.electoralArea + '</td></tr>';
				}

				if(props.score) {
					str += '<tr><td class="rowName">Score:</td><td>' + props.score + '</td></tr>';
					str += '<tr><td class="rowName">Match Precision:</td><td>' + props.matchPrecision + '</td></tr>';
					str += '<tr><td class="rowName">Precision Points:</td><td>' + props.precisionPoints + '</td></tr>';
					str += '<tr><td class="rowName">Faults:</td><td><table class="popup-table">';
					for(var i = 0, len = props.faults.length; i < len; i++) {
						var f = props.faults[i];
						str += '<tr><td>"' + f.value + '"</td><td>' + f.element + '.<wbr>' + f.fault + '</td><td>' + f.penalty + '</td></tr>';
					}
					str += '</table></td></tr>';
				}

				if(props.degree) {
					str += '<tr><td class="rowName">Degree:</td><td>' + props.degree + '</td></tr>';
				}

				if(props.occupantName) {
					str += '<tr><td class="rowName">Image URL</td><td>';
					if(props.imageUrl) {
						str += '<img url="' + props.imageUrl + '"/>';
					} else {
						str += 'No Image';
					}
					str	+= '</td></tr>';
					str += '<tr><td class="rowName">Occupant Description</td><td>' + props.occupantDescription + '</td></tr>';
					str += '<tr><td class="rowName">Website Url</td><td>' + props.websiteUrl.replace(/\//g, '/<wbr>') + '</td></tr>';
					str += '<tr><td class="rowName">Contact E-mail</td><td>' + props.contactEmail + '</td></tr>';
					str += '<tr><td class="rowName">Contact Phone</td><td>' + props.contactPhone + '</td></tr>';
					str += '<tr><td class="rowName">Contact Fax</td><td>' + props.contactFax + '</td></tr>';
					str += '<tr><td class="rowName">Keywords</td><td>' + props.keywords.replace(/;/g, ';<wbr>') + '</td></tr>';
					str += '<tr><td class="rowName">Business Category Class</td><td>' + props.businessCategoryClass + '</td></tr>';
					str += '<tr><td class="rowName">NAICS Code</td><td>' + props.naicsCode + '</td></tr>';
				}

				str += '</table>';
			}
			return str;
		}

		// reverse geocode on map Click
		map.on('click', function(e) {
			if($('#tabs-2').hasClass('active')) {
				$('#addAddrField').val(e.latlng.lat.toFixed(5) + "," + e.latlng.lng.toFixed(5));
			}
		});

		// event handler for add to route button inside site address popup
		$('#map').on('click', '#addSiteToRouteBtn', function(e) {
			addDest($(this).parent().find('.popup-title').text());
		});

		// reusable function for suggesting geocode autocompletion options
		function geocodeSuggest(request, response, options) {
			var params = {
				minScore: 50,
				maxResults: 5,
				echo: true,
				brief: true,
				autoComplete: true,
				matchPrecisionNot: matchPrecisionNot,
				addressString: request.term
			};
			$.extend(params, options);
			$.ajax({
				url: gcApi + "addresses.json",
				data: params,
				success: function(data) {
					var list = [];
					if(data.features && data.features.length > 0) {
						list = data.features.map( function(item) {
							return {
								value: item.properties.fullAddress,
								data: item
							}
						});
					}
					response(list);
				},
				error: function() {
					response([]);
				}
			});
		}

		// function to convert json or a latlng into a layer and put it on the map
		function receiveGeocode(data, center=true) {
			var layer;
			if(data instanceof L.LatLng) {
				layer = latLngToLayer(data);
			} else {
				layer = L.geoJson(data, {
					onEachFeature: function(feature, layer) {
						layer.bindPopup(makePopupText(feature.properties));
						layer.options['title'] = feature.properties.fullAddress;
						//layer.bindTooltip(feature.properties.fullAddress, {
						//		permanent: true
						//	}).openTooltip();
					}
				});
				var feature = data;
				if(data.features) {
					feature = data.features[0];
				}
				lookupAdminAreas(feature.properties.fullAddress, feature.geometry.coordinates);
			}
			if(geocodeLayer) {
				map.removeLayer(geocodeLayer);
			}
			geocodeLayer = layer;
			layer.addTo(map);
			centerMap(geocodeLayer.getBounds(), center);
		}

		function lookupAdminAreas(address, coords) {
			$('#adminAreaInfo').html("<b>" + address + "</b><br/>is in the following admin areas:<br/>");
			lookupCHSAInfo(coords);
		}

		function lookupCHSAInfo(coords) {
			var params = {
				service: "WFS",
				version: "1.0.0",
				request: "GetFeature",
				typeName: "pub:WHSE_ADMIN_BOUNDARIES.BCHA_CMNTY_HEALTH_SERV_AREA_SP",
				srsname: "EPSG:4326",
				cql_filter: "INTERSECTS(SHAPE,SRID=4326;POINT(" + coords[0] + " " + coords[1] + "))",
				propertyName: "CMNTY_HLTH_SERV_AREA_CODE,CMNTY_HLTH_SERV_AREA_NAME,LOCAL_HLTH_AREA_CODE,LOCAL_HLTH_AREA_NAME,HLTH_SERVICE_DLVR_AREA_CODE,HLTH_SERVICE_DLVR_AREA_NAME,HLTH_AUTHORITY_CODE,HLTH_AUTHORITY_NAME",
				outputFormat: "application/json",
			};

			$.ajax({
				url: "https://openmaps.gov.bc.ca/geo/pub/ows",
				data: params,
				type: "GET",
				dataType: "json",
				success: function (response, textStatus, jqXHR) {
					var f = response.features[0];
					$('#adminAreaInfo').append("CHSA: " + f.properties['CMNTY_HLTH_SERV_AREA_NAME'] + " (" + f.properties['CMNTY_HLTH_SERV_AREA_CODE'] + ")<br/>");
					$('#adminAreaInfo').append("LHA: " + f.properties['LOCAL_HLTH_AREA_NAME'] + " (" + f.properties['LOCAL_HLTH_AREA_CODE'] + ")<br/>");
					$('#adminAreaInfo').append("CSDA: " + f.properties['HLTH_SERVICE_DLVR_AREA_NAME'] + " (" + f.properties['HLTH_SERVICE_DLVR_AREA_CODE'] + ")<br/>");
					$('#adminAreaInfo').append("HA: " + f.properties['HLTH_AUTHORITY_NAME'] + " (" + f.properties['HLTH_AUTHORITY_CODE'] + ")<br/>");
				},
		    error: function(xhr, err) {
		  	}
		  });	// end ajax call
		} // end lookupCHSAInfo function

		// Geocode Address autocomplete
		$('#geocodeField').autocomplete({
			minLength: 3,
			source: geocodeSuggest,
			select: function(evt, ui) {
				receiveGeocode(ui.item.data);
			}
		});

		var geocodeLayer = null;

		// Geocode Address event handler
		function geocode($field, callback, locationDescriptor = 'parcelPoint') {
			var latLng = isCoords($field.val());
			if(latLng) {
				callback(latLng);
			} else {
				$.ajax({
					url: gcApi + "addresses.json",
					data: {
						matchPrecisionNot: matchPrecisionNot,
						locationDescriptor: locationDescriptor,
						echo: true,
						brief: true,
						addressString: $field.val()
					},
					success: callback,
					error: function(request) {
						alert(baseErrorMsg + "Error retrieving geocode results, please try your search again.");
						console.log(request);
					}
				});
			}
		}

		$('#geocodeField').keypress(function(e) {
 			if(e.which == 13) {
				if(geocodeLayer) {
					map.removeLayer(geocodeLayer);
					geocodeLayer = null;
				}
    		geocode($('#geocodeField'), receiveGeocode);
    		return false;
  		}
		});

		$('#geocodeBtn').on("click", function() {
			if(geocodeLayer) {
				map.removeLayer(geocodeLayer);
				geocodeLayer = null;
			}
			geocode($('#geocodeField'), receiveGeocode);
		});

		$('#randomBtn').on("click", function() {
			if(geocodeLayer) {
				map.removeLayer(geocodeLayer);
				geocodeLayer = null;
			}
			randomAddress($('#geocodeField'), 'parcelPoint', function(data) {
				receiveGeocode(data, false);
			});
		});

		$('#gmapsBtn').on("click", function() {
			window.open('http://maps.google.com/?q=' + $('#geocodeField').val());
		});

		$('#listBtn').on("click", function() {
			var url = gcApi + "addresses.xhtml"
					+	"?locationDescriptor=parcelPoint&echo=true&brief=true"
					+ "&minScore=50&maxResults=5&autoComplete=true"
					+ "&matchPrecisionNot=" + matchPrecisionNot
					+ "&addressString=" + $('#geocodeField').val();
			window.open(url);
		});

		$('#addressClear').on("click", function() {
			if(geocodeLayer) {
				map.removeLayer(geocodeLayer);
				geocodeLayer = null;
			}
		});

		// Routing
		var routeLayer;
		var routeRequest;
		var betweenPairsRequest;

		function getRouteIcon(index) {
			if(index == 0) {
				return greenIcon;
			} else if(index == -1) {
				return redIcon;
			} else {
				return new L.NumberedIcon({number: index});
			}
		}

		function clearRoute() {
			$('#timing').empty();
			$('#notifications').empty();
			$('#directionsHeader').empty();
			$('#directions').empty();
			if(routeLayer) {
				map.removeLayer(routeLayer);
				routeLayer = null;
			}
			if(directionSelectMarker != null) {
				map.removeLayer(directionSelectMarker);
			}
		}

		function route($field, center = true) {
			// test will be an empty string if all inputs have a point
			var test = $('#routerList input.input-field').map( function(index, element) {
				if( $(element).data('marker') ) {
					return "";
				}
				return "1";
			}).get().join("");
			if(test != "") {
				if($field && center) {
					map.panTo($field.data('marker').getLatLng());
				}
				return;
			}
			clearRoute();
			$('#timing').html('Calculating Route...');

			var params = {};
			params['points'] = $('#routerList input.input-field').map( function(index, element) {
				var latLng = $(element).data('marker').getLatLng();
				return latLng.lng + "," + latLng.lat;
			}).get().join(',');

			params['criteria'] = $('input[name=criteria]:checked').val();
			params['enable'] = "";

			if($('#ferrySchedulesChk').is(':checked')) {
				params['enable'] += "sc,";
			}
			if($('#trafficChk').is(':checked')) {
				params['enable'] += "tf,";
			}
			if($('#eventsChk').is(':checked')) {
				params['enable'] += "ev,";
			}
			if($('#gdfChk').is(':checked')) {
				params['enable'] += "gdf,";
				params['gdf'] = buildGdfString();
			}
			if($('#ldfChk').is(':checked')) {
				params['enable'] += "ldf,";
			}
			if($('#timeDependentChk').is(':checked')) {
				params['enable'] += "td,";
			}
			if($('#turnRestrictionsChk').is(':checked')) {
				params['enable'] += "tr,";
			}
			if($('#xingCostsChk').is(':checked')) {
				params['enable'] += "xc,";
				params['xingCost'] = buildXingCostString();
			}
			if($('#turnCostsChk').is(':checked')) {
				params['enable'] += "tc,";
				if($('#truckControlsChk').is(':checked')) {
					params['turnCost'] = $('#leftTruckTurnCost').val() + "," + $('#rightTruckTurnCost').val();
				} else {
					params['turnCost'] = $('#leftTurnCost').val() + "," + $('#rightTurnCost').val();
				}
			}
			var date = $('#time').timepicker('getTime', $('#date').datepicker('getDate'));
			params['departure'] = date2String(date);
			var queryPrefix = ""
			if($('#truckControlsChk').is(':checked')) {
				queryPrefix = "truck/";
				params['partition'] = "isTruckRoute";
				if($('#followTruckRouteChk').is(':checked')) {
					params['followTruckRoute'] = "true";
				}
				if($('#truckRouteMultiplier').val()) {
					params['truckRouteMultiplier'] = $('#truckRouteMultiplier').val();
				}
				if($('#height').val()) {
					params['height'] = $('#height').val();
				}
				if($('#width').val()) {
					params['width'] = $('#width').val();
				}
				if($('#length').val()) {
					params['length'] = $('#length').val();
				}
				if($('#weight').val()) {
					params['weight'] = $('#weight').val();
				}
			}

			if($('#correctSideChk').is(':checked')) {
				params['correctSide'] = 'true';
			} else {
				params['correctSide'] = 'false';
			}

			var query = 'directions.json';

			if($('#optimizeChk').is(':checked')) {
				query = 'optimalDirections.json';
			}

			if($('#roundTripChk').is(':checked')) {
				params['roundTrip'] = 'true';
			} else {
				params['roundTrip'] = 'false';
			}

			if($('#nearestStopChk').is(':checked')) {
				doBetweenPairsRequest(params, center);
			} else {
				doRouteRequest(queryPrefix + query, params, center);
			}
		}

		function doBetweenPairsRequest(params, center) {
			params['maxPairs'] = 1;
			var match = params['points'].match(/([^,]*,[^,]*),(.*)/);
			params['fromPoints'] = match[1];
			params['toPoints'] = match[2];
			params['points'] = undefined;
			if(betweenPairsRequest != null) {
				betweenPairsRequest.abort();
			}
			betweenPairsRequest = $.ajax({
				url: routeApi + 'distance/betweenPairs.json?' + routeQuery,
				method: routeMethod,
				headers: routeHeaders,
				data: params,
				success: function(data) {
					if(data.pairs[0] && data.pairs[0].routeFound) {
						var fromPoint = data.fromPoints[data.pairs[0].from];
						var toPoint = data.toPoints[data.pairs[0].to];
						params['points'] = fromPoint[0] + ',' + fromPoint[1] + ',' + toPoint[0] + ',' + toPoint[1];
						doRouteRequest('directions.json', params, center);
					} else {
						$('#timing').html("No route exists in the BC Digital Road Atlas between the first and any of the other points.");
					}
				},
				error: function(request) {
					if(request.statusText != "abort") {
						alert(baseErrorMsg + "Error retrieving betweenPairs results, please try your route again.");
						$('#timing').html("Error retrieving route results, please try your route again.");
						console.log(request);
					}
				}
			});
		}

		function addTestResults(ids) {
			$.ajax({
				url: "http://office.refractions.net/~chodgson/gc/test/result_geojson.php?ids=" + ids,
				dataType: "json",
				success: function(data) {
					var testResultsLayer = L.geoJSON(data.features, {
						style: getTestStyle,
						pane: map.getPane('routePane')
					});
					testResultsLayer.bindPopup(function(layer) {
						return makeTestResultPopupText(layer.feature.properties);
					});
					// add start and end markers, and partition markers
					for(var i = 0; i < data.features.length; i++) {
						var coords = data.features[i].geometry.coordinates
						var startCoord = coords[0];
						var endCoord = coords[coords.length-1];
						if(Array.isArray(startCoord[0])) {
							startCoord = startCoord[0];
							endCoord = endCoord[endCoord.length-1];
						}
						testResultsLayer.addLayer(L.marker(L.GeoJSON.coordsToLatLng(startCoord), {icon: getRouteIcon(0)}));
						testResultsLayer.addLayer(L.marker(L.GeoJSON.coordsToLatLng(endCoord), {icon: getRouteIcon(-1)}));
						// add partition markers
						var partition_indices = data.features[i].properties.partition_indices;
						for(var j = 0; j < partition_indices.length; j++) {
							var index = partition_indices[j];
							if(index != '') {
								var coord = data.features[i].geometry.coordinates[index];
								testResultsLayer.addLayer(L.circleMarker(L.GeoJSON.coordsToLatLng(coord), {color: "red"}));
							}
						}
					}
					testResultsLayer.addTo(map);
					centerMap(testResultsLayer.getBounds());
				}
			});
		}

		var testColors = ['green','yellow'];
		var testColorIdx = 0;
		function getTestStyle(feature) {
			var style = {color: testColors[testColorIdx], opacity: '0.6', weight: 4};
			testColorIdx = (testColorIdx + 1) % testColors.length;
			return style;
		}

		function doRouteRequest(query, params, center) {
			if(routeRequest != null) {
				routeRequest.abort();
			}
			routeRequest = $.ajax({
				url: routeApi + query + '?' + routeQuery,
				method: routeMethod,
				headers: routeHeaders,
				data: params,
				success: function(data) {
					clearRoute();
					// if a valid route was returned
					if(data.route && data.route.length > 1) {
						if(data.partition) {
							var features = [];
							for(var p = 0; p < data.partitions.length; p++) {
								var end = data.route.length;
								if(p < data.partitions.length - 1) {
									end = data.partitions[p+1].index + 1;
								}
								features.push({
									type: "Feature",
									properties: {
										isTruckRoute: data.partitions[p].isTruckRoute
									},
									geometry: {
										type: "LineString",
							      coordinates: data.route.slice(data.partitions[p].index, end)
									}
								});
							}
							var geoJson = {
								type: "FeatureCollection",
								features: features
							};
							routeLayer = L.geoJson(geoJson, {
									pane: map.getPane('routePane'),
									onEachFeature: function(feature, layer) {
										if(feature.properties.isTruckRoute) {
											layer.setStyle({
												color:"#0000FF",
												weight:7,
												opacity: 0.75
											});
										} else {
											layer.setStyle({
												color:"#FF0000",
												weight:7,
												opacity: 0.75,
											  lineCap: 'butt',
											  dashArray: '7 4'
										  });
										}
								}
							}).addTo(map);
						} else {
							routeLayer = L.geoJson({
									type: "Feature",
									properties: {},
									geometry: {
										type: "LineString",
										coordinates: data.route
									}
								}, {
									pane: map.getPane('routePane'),
									onEachFeature: function(feature, layer) {
										var color = "#0000FF";
										if(params['criteria'] == "fastest") {
											color = "#FF00FF";
										}
										layer.setStyle({color:color, weight:7, opacity: 0.75});
								}
							}).addTo(map);
						}
						if(center) {
							centerMap(routeLayer.getBounds(), center);
						}

						// update icon numbering
						$('#routerList input.input-field').each( function(index, element) {
							var layer = $(element).data('marker');
							if(data.visitOrder) {
								index = data.visitOrder[index];
								if(index == data.visitOrder.length - 1) {
									index = -1;
								}
							} else if($(element).parents('div.form-group').next().length == 0) {
								index = -1;
							}
							if(layer) {
								layer.setIcon(getRouteIcon(index));
							}
						});
					}

					// var $last;
					// if(data.visitOrder) {
					// 	$last = $('#routerList input.input-field:nth-child(' + (data.visitOrder[data.visitOrder.length-1] + 1) +')');
					// } else {
					// 	$last = $('#routerList input.input-field').filter(':last');
					// }
					// if($last.data('marker')) {
					// 	$last.data('marker').setIcon(getRouteIcon(-1));
					// }
					if(data.routeFound) {
						if(data.optimizationExecutionTime) {
							$('#timing').html('Distances between stops calculated in ' + data.routingExecutionTime/1000 + ' seconds<br\>'
								+ 'Optimization performed in ' + data.optimizationExecutionTime/1000 + ' seconds<br\>'
								+ 'Final route calculated in ' + (data.executionTime - data.routingExecutionTime - data.optimizationExecutionTime)/1000 + ' seconds<br\>'
								+ 'Route travels ' + data.distance + ' km in ' + data.timeText);
						} else {
							$('#timing').html('Route calculated in ' + data.executionTime/1000 + ' seconds<br\>Route travels ' + data.distance + ' km in ' + data.timeText);
						}
						var notes = data.notifications;
						if(notes) {
							for(i = 0; i < notes.length; i++) {
								var $note = $("<div class=\"notification\">" + notes[i].message + "</div>");
								$('#notifications').append($note);
							}
						}
						$('#directionsHeader').html('Directions:');
						var dirs = data.directions;
						for(i = 0; i < dirs.length; i++) {
							var $dir = $("<div class=\"direction\" title=\"Click to zoom in to start of route leg.\"></div>");
							$dir.append("<div class=\"" + dirs[i].type + "\"></div>");
							$dirBody = $("<div class=\"dirBody\"></div>");
							if(dirs[i].notifications) {
								var notes = dirs[i].notifications;
								for(n = 0; n < notes.length; n++) {
									$dirBody.append("<div class=\"notification " + notes[n].type + "\">" + notes[n].message + "</div>");
								}
							}
							$dirBody.append(dirs[i].text);
							$dir.append($dirBody);
							$('#directions').append($dir);
							$dir.data('latlng', {'lat': dirs[i].point[1], 'lng': dirs[i].point[0]});
						}
					} else {
						$('#timing').html('No route exists in the BC Digital Road Atlas<br\>');
					}
				},
				error: function(request) {
					if(request.statusText != "abort") {
						alert(baseErrorMsg + "Error retrieving route results, please try your route again.");
						$('#timing').html("Error retrieving route results, please try your route again.");
						console.log(request);
					}
				}
			});
		}

		Sortable.create(document.getElementById('routerList'),{
			handle: ".reorder",
			draggable: ".form-group",
			forceFallback: true,
			onUpdate: function(evt) {
				route(null);
			}
		});

		// press enter on router field
		$('#routerList').on('keypress', 'input.input-field', function(e) {
			if(e.which == 13) {
				var latLng = isCoords($(this).val());
				if(latLng) {
    				receiveRouteGeocode(latLng, $(this));
				}
    			return false;
  			}
		});

		// pick random location button
		$('#routerList').on('click', 'button.random', function() {
			clearRoute();
			randomAddress($(this).parents('div.form-group').find('input.input-field'), 'accessPoint', function(data, $field) {
				receiveRouteGeocode(data, $field, false);
			}, $('#timing'));
		});

		// open in gmaps button
		$('#routerList').on('click', 'button.gmaps', function() {
			window.open('http://maps.google.com/?q='
					+ $(this).parents('div.form-group').find('input.input-field').val());
		});

		// zoom to Location button
		$('#routerList').on('click', 'button.zoom-to', function() {
			var $inputField = $(this).parents('div.input-group').find('input.input-field');
			var marker = $inputField.data('marker');
			if(marker) {
				centerMap(marker.getLatLng().toBounds(10), true);
			}
		});

		// copy to clipboard from addAddrField
		new ClipboardJS('.copyToClipboardBtn');

		// clear router input field button
		$('#routerList').on('click', 'button.input-clear', function() {
			clearRoute();
			var $inputField = $(this).parents('div.input-group').find('input.input-field');
			var marker = $inputField.data('marker');
			if(marker) {
				map.removeLayer(marker);
			}
			// if there are more than 2 destinations
			if($('#routerList > div.form-group').size() > 2) {
				// delete this destination field and route the remaining fields
				$(this).parents('div.form-group').remove();
				route(null);
			} else {
				// must leave at least 2 fields, just clear this field
				$inputField.val('');
				$inputField.data('marker', null);
			}
		});

		function addDest(address = '') {
			var $input = $('#routerList input.input-field').filter(function(index) {
				return $(this).val() == '';
			}).first();
			if(address == '' || $input.size() != 1) {
				var $formGroup = $('#routerList > div.form-group:first-child').clone().appendTo('#routerList');
				$input = $formGroup.find('input.input-field');
				$input.val('');
				$input.data('marker', null);
				$input.autocomplete({
					minLength: 3,
					source: function(request, response) {
						geocodeSuggest(request, response, {
							locationDescriptor: 'accessPoint'
						});
					},
					select: function(evt, ui) {
						receiveRouteGeocode(ui.item.data, $(evt.target));
					}
				});
				$formGroup[0].scrollIntoView(false);
			}
			if(address != '') {
				$input.val(address);
				geocode($input, function(data) {
					receiveRouteGeocode(data, $input);
				}, 'accessPoint');
			}
		}

		// add destination button
		$('#addDestBtn').on('click', function() {
			addDest($('#addAddrField').val());
			$('#addAddrField').val('');
		});

		$('input[name=criteria]').on('change', function(evt) {
			route(null, false);
		});

		$('#configDialog').dialog({
			autoOpen: false,
			resizable: false,
			height: 785,
			width: 450
		});
		$('.configDialogLink').on('click', function(evt) {
			$('#configDialog').dialog('open');
		});

		$('.routeOnChange').on('change', function(evt) {
			route(null, false);
		});
		// need this to catch change events from dynamically added config inputs
		$('#configDialog').on('change', '.routeOnChange', function(evt) {
			updateConfigString();
			route(null, false);
		});

		$('#configString').on('change', function(evt) {
			var s = $('#configString').val();
			s.split("&").forEach(function(item) {
				var pair = item.split("="), key = pair[0], value = pair[1];
				switch(key) {
					case 'globalDistortionField' :
						value.split(",").forEach(function(gdf) {
							var pair = gdf.split(":"), key = pair[0], value = pair[1];
							$('#' + key.replace(/\./g, "\\.")).val(value);
						});
						break;
					case 'xingCost':
						var xingCosts = value.split(",");
						$('#yieldCost').val(xingCosts[0]);
						$('#signCost').val(xingCosts[1]);
						$('#lightCost').val(xingCosts[2]);
						$('#multiplier').val(xingCosts[3]);
					  break;
					case 'turnCost':
						var turnCosts = value.split(",");
						$('#leftTurnCost').val(turnCosts[0]);
						$('#rightTurnCost').val(turnCosts[1]);
						$('#leftTruckTurnCost').val(turnCosts[2]);
						$('#rightTruckTurnCost').val(turnCosts[3]);
				}
			});
		});

		$('#date').on('change', function(evt) {
			trafficLayer.refresh();
			ferryScheduleLayer.refresh();
		});
		$('#time').on('change', function(evt) {
			trafficLayer.refresh();
			ferryScheduleLayer.refresh();
		});

		$('#roundTripChk').on('change', function(evt) {
			$('#nearestStopChk').prop('checked', false);
			route(null, false);
		});

		$('#optimizeChk').on('change', function(evt) {
			$('#nearestStopChk').prop('checked', false);
			route(null, false);
		});

		$('#nearestStopChk').on('change', function(evt) {
			$('#optimizeChk').prop('checked', false);
			$('#roundTripChk').prop('checked', false);
			route(null, false);
		});

		$('#timeDependentChk').on('change', function(evt) {
			$('#ferrySchedulesChk').prop('checked', false);
			$('#trafficChk').prop('checked', false);
			$('#eventsChk').prop('checked', false);
			route(null, false);
		});

		$('#eventsChk').on('change', function(evt) {
			$('#timeDependentChk').prop('checked', true);
			route(null, false);
		});

		$('#ferrySchedulesChk').on('change', function(evt) {
			$('#timeDependentChk').prop('checked', true);
			route(null, false);
		});

		$('#trafficChk').on('change', function(evt) {
			$('#timeDependentChk').prop('checked', true);
			route(null, false);
		});

		$('#truckControls').hide();
		$('#truckControlsChk').on('change', function(evt) {
			$('#truckControls').toggle();
		});

		var directionMarker = null;
		var directionSelectMarker = null;

		$('#directions').on('mouseenter', 'div.direction', function(evt) {
			if(directionMarker != null) {
				map.removeLayer(directionMarker);
			}
			var latlng = $(evt.target).data('latlng');
			if(latlng) {
				directionMarker = L.circleMarker(latlng, {pane:'popupPane'}).addTo(map);
			}
		});

		$('#directions').on('mouseleave', 'div.direction', function(evt) {
			if(directionMarker != null) {
				map.removeLayer(directionMarker);
			}
		});

		$('#directions').on('click', 'div.direction', function(evt) {
			var $dirDiv = $(evt.currentTarget);
			if(directionSelectMarker != null) {
				map.removeLayer(directionSelectMarker);
			}
			if($dirDiv.hasClass('selectedDirection')) {
				$dirDiv.removeClass('selectedDirection')
					.prop('title', 'Click to zoom in to start of route leg.');
				centerMap(routeLayer.getBounds());
			} else {
				$('#directions div.selectedDirection').removeClass('selectedDirection')
					.prop('title', 'Click to zoom in to start of route leg.');
				$dirDiv.addClass('selectedDirection')
					.prop('title', 'Click to zoom out to route extent.');
				var latlng = $dirDiv.data('latlng');
				if(latlng) {
					directionSelectMarker = L.circleMarker(latlng).addTo(map);
					centerMap(L.latLngBounds(latlng, latlng));
				}
			}
		});

		function receiveRouteGeocode(data, $field, center = true) {
			var layer, latLng;
			var pos = $field.parents('div.form-group').index();
			var icon = getRouteIcon(pos);
			if(data instanceof L.LatLng) {
				latLng = data;
			} else {
				// sort out whether we have a single feature or a featureCollection
				var feature = data;
				if(data.features) {
					feature = data.features[0];
				}
				$field.val(feature.properties.fullAddress);
				latLng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
			}
			layer = L.marker(latLng, {icon: icon, draggable: true, autoPan: true});
			layer.on('moveend', function(ev) {
				$('#routerList input.input-field').each( function(index, element) {
					if($(element).data('marker') == ev.target) {
						var ll = ev.target.getLatLng();
						$(element).val(ll.lat.toFixed(5) + "," + ll.lng.toFixed(5));
						return false;
					}
					return true;
				});
				route(null, false);
			});
			if(feature) {
				layer.bindPopup(makePopupText({'fullAddress': feature.properties.fullAddress}));
				layer.options['title'] = feature.properties.fullAddress;
				//layer.bindTooltip(feature.properties.fullAddress, {
				//		permanent: true
				//	}).openTooltip();
			} else {
				layer.bindPopup('<span class="popup-title">' + latLng.lat + "," + latLng.lng + '</span>');
				layer.options['title'] = "" + latLng.lat + "," + latLng.lng;
			}

			var oldMarker = $field.data('marker');
			if(oldMarker) {
				map.removeLayer(oldMarker);
			}
			$field.data('marker', layer);
			layer.addTo(map);
			route($field, center);
		}

		// Routing - Address autocomplete
		$('#routerList input.input-field').autocomplete({
			minLength: 3,
			source: function(request, response) {
				geocodeSuggest(request, response, {
					locationDescriptor: 'accessPoint'
				});
			},
			select: function(evt, ui) {
				receiveRouteGeocode(ui.item.data, $(evt.target));
			}
		});

		// setup default chekboxes based on server defaults
		$.ajax({
			url: routeApi + "defaults.json?" + routeQuery,
			headers: routeHeaders,
			success: function(data) {
				for(var i = 0; i < data.enableOptions.length; i++) {
					switch(data.enableOptions[i]) {
						case 'td' :
							$('#timeDependentChk').prop('checked', true);
							break;
						case 'tr' :
							$('#turnRestrictionsChk').prop('checked', true);
							break;
						case 'ldf' :
							$('#ldfChk').prop('checked', true);
							break;
						case 'gdf' :
							$('#gdfChk').prop('checked', true);
							break;
						case 'xc' :
							$('#xingCostsChk').prop('checked', true);
							break;
						case 'tc' :
							$('#turnCostsChk').prop('checked', true);
							break;
						case 'ev' :
							$('#eventsChk').prop('checked', true);
							break;
						case 'tf' :
							$('#trafficChk').prop('checked', true);
							break;
						case 'sc' :
							$('#ferrySchedulesChk').prop('checked', true);
							break;
					}
				}
				// build/populate config table with default values
				if(data.defaultTruckRouteMultiplier) {
					$('#truckRouteMultiplier').val(data.defaultTruckRouteMultiplier);
				}
				if(data.xingCost) {
					var xingCosts = data.xingCost.split(",");
					$('#yieldCost').val(xingCosts[0]);
					$('#signCost').val(xingCosts[1]);
					$('#lightCost').val(xingCosts[2]);
					$('#multiplier').val(xingCosts[3]);
				}
				if(data.turnCost) {
					var turnCosts = data.turnCost.split(",");
					$('#leftTurnCost').val(turnCosts[0]);
					$('#rightTurnCost').val(turnCosts[1]);
					$('#leftTruckTurnCost').val(turnCosts[2]);
					$('#rightTruckTurnCost').val(turnCosts[3]);
				}
				if(data.globalDistortionField) {
					$tbody = $("#gdfTable > tbody");
					$tbody.empty();
					const keys = Object.keys(data.globalDistortionField);
					for (const key of keys) {
						if(key.endsWith(".truck")) continue;
						var value = data.globalDistortionField[key];
						var truckValue = data.globalDistortionField[key + ".truck"];
						$tbody.append("<tr><td>" + key + "</td>"
							  + "<td><input id=\"" + key + "\" class=\"routeOnChange gdf\" value=\"" + value
										+ "\" required type=\"number\" min=\"0.1\" max=\"10\" step=\"any\"></td>"
								+ "<td><input id=\"" + key + ".truck\" class=\"routeOnChange gdf\" value=\"" + truckValue
								    + "\" required type=\"number\" min=\"0.1\" max=\"10\" step=\"any\"></td></tr>");
					}
				}
				updateConfigString();
			},
			error: function(request) {
				// alert(baseErrorMsg + "Error retrieving default config from server.");
				console.log(request);
			}
		});

		var occsByTagLayer;

		// Tag-it setup (including autocomplete) for Occupants by tag
		$('#tags').tagit({
			allowSpaces: true,
			autocomplete: {
				source: function(request, response) {
					$.ajax({
						url: gcApi + "occupants/tags.json",
						data: {tag: request.term},
						success: response,
						error: function() {
							response([]);
						}
					});
				}
			}
		});

		$('.tagit-new > input').prop('placeholder', 'Enter tags');

		// Find nearby Occupants by Tag event handler
		$('#findOccsByTag').on("click", function() {
			if(occsByTagLayer) {
				map.removeLayer(occsByTagLayer);
				occsByTagLayer = null;
			}
			var tagList = $('#tags').tagit("assignedTags").join(";");
			occsByTagLayer = new L.layerJSON({
				url: gcApi + "occupants/within.json?tags=" + tagList + "&bbox={lon1},{lat1},{lon2},{lat2}",
				caching: false,
				propertyItems: "features",
				propertyId: "properties.fullAddress",
				locAsGeoJSON: true,
				propertyLoc: "geometry.coordinates",
				buildIcon: function() {
					return occIcon;
				},
				onEachMarker: function(feature, layer) {
					layer.bindPopup(makePopupText(feature.properties));
					layer.options['title'] = feature.properties.fullAddress;
				}
			});
			occsByTagLayer.addTo(map);
		});

		$('#clearTags').on('click', function() {
			$('#tags').tagit('removeAll');
			if(occsByTagLayer) {
				map.removeLayer(occsByTagLayer);
				occsByTagLayer = null;
			}
		})

		// Find Occupants By Name Autocomplete
		$('#nameField').autocomplete({
			minLength: 4,
			source: function(request, response) {
				$.ajax({
					url: gcApi + "occupants/addresses.json",
					data: {
						minScore: 50,
						maxResults: 5,
						echo: false,
						autoComplete: true,
						brief: true,
						addressString: request.term
					},
					success: function(data) {
						var list = [];
						if(data.features && data.features.length > 0) {
							list = data.features.map( function(item) {
								return {
									value: item.properties.fullAddress,
									data: item
								};
							});
						}
						response(list);
					},
					error: function() {
						response([]);
					}
				});
			},
			select: function(evt,ui) {
				if(namedOccLayer) {
					map.removeLayer(namedOccLayer);
				}
				namedOccLayer = L.geoJson(ui.item.data, {
					onEachFeature: function(feature, layer) {
						layer.bindPopup(makePopupText(feature.properties));
						layer.options['title'] = feature.properties.fullAddress;
					}
				}).addTo(map);
				centerMap(namedOccLayer.getBounds());
			}
		});

		var namedOccLayer;

		// Find Occupants By Name event handler
		function findOccs($field) {
			var addr = $field.val();
			$.ajax({
				url: gcApi + "occupants/addresses.json",
				data: {
					echo: 'false',
					brief: true,
					addressString: addr
				},
				success: function(data) {
					if(namedOccLayer) {
						map.removeLayer(namedOccLayer);
						namedOccLayer = null;
					}
					namedOccLayer = L.geoJson(data, {
						onEachFeature: function(feature, layer) {
							layer.bindPopup(makePopupText(feature.properties));
							layer.options['title'] = feature.properties.fullAddress;
						}
					}).addTo(map);
					centerMap(namedOccLayer.getBounds());
				},
				error: function(request) {
					alert(baseErrorMsg + "Error retrieving occupants by name, please try your search again.");
					console.log(request);
				}
			});
		};

		$('#nameField').keypress(function(e) {
			if(e.which == 13) {
				findOccs($('#nameField'));
				return false;
			}
		});

		$('#findOccsByName').on("click", function() {
			findOccs($('#nameField'));
		});

		$('#nameClear').on('click', function() {
			if(namedOccLayer) {
				map.removeLayer(namedOccLayer);
				namedOccLayer = null;
			}
		});


		// isochrones
		var isoLayer = null;
		var isoRequest = null;

		function clearIsochrone() {
			if(isoLayer) {
				map.removeLayer(isoLayer);
				isoLayer = null;
			}
		}

		$('#isoClear').on('click', function() {
			var oldMarker = $('#isoGeocodeField').data('marker');
			if(oldMarker) {
				map.removeLayer(oldMarker);
			}
			$('#isoGeocodeField').data('marker', layer);
			clearIsochrone();
		});

		function receiveIsoGeocode(data) {
			var layer, latLng;
			if(data instanceof L.LatLng) {
				latLng = data;
				layer = latLngToLayer(data, {icon: icon});
			} else {
				// sort out whether we have a single feature or a featureCollection
				var feature = data;
				if(data.features) {
					feature = data.features[0];
				}
				$('#isoGeocodeField').val(feature.properties.fullAddress);
				latLng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
				layer = L.geoJson(data, {
					onEachFeature: function(feature, layer) {
						layer.bindPopup(makePopupText({'fullAddress': feature.properties.fullAddress}));
						layer.options['title'] = feature.properties.fullAddress;
					}
				});
			}
			var oldMarker = $('#isoGeocodeField').data('marker');
			if(oldMarker) {
				map.removeLayer(oldMarker);
			}
			$('#isoGeocodeField').data('marker', layer);
			layer.addTo(map);
			doIsochrone();
		}

		$('#isoGeocodeField').autocomplete({
			minLength: 3,
			source: function(request, response) {
				geocodeSuggest(request, response, {
					locationDescriptor: 'accessPoint'
				});
			},
			select: function(evt, ui) {
				receiveIsoGeocoder(ui.item.data);
			}
		});

		// pick random location button
		$('#isoRandom').on('click', function() {
			clearIsochrone();
			randomAddress($('#isoGeocodeField'), 'accessPoint', function(data) {
				receiveIsoGeocode(data);
			});
		});

		$('#zoneSize').on('change', doIsochrone);
		$('#zoneCount').on('change', doIsochrone);
		$('#inboundChk').on('change', doIsochrone);

		function doIsochrone() {
			var latLng = $('#isoGeocodeField').data('marker').getLatLng();
			var params = {
				point : latLng.lng + "," + latLng.lat,
				zoneSize : $('#zoneSize').val(),
				zoneCount : $('#zoneCount').val()
			}
			if($('#inboundChk').is(':checked')) {
				params['inbound'] = 'true';
			} else {
				params['inbound'] = 'false';
			}

			if(isoRequest != null) {
				isoRequest.abort();
			}

			var service = "isochrones";
			if($('#testChk').is(':checked')) {
				service = "loop";
			}
			isoRequest = $.ajax({
				url: routeApi + service + ".json?" + routeQuery,
				method: "GET", //routeMethod,
				//headers: routeHeaders,
				data: params,
				success: function(data) {
					clearIsochrone();
					// if valid isochrones were returned
					if(data) {
						isoLayer = L.geoJson(data, {
							// onEachFeature: function(feature, layer) {
							// 	var color = "#0000FF";
							// 	layer.setStyle({color:color, weight:7, opacity: 0.5});
							//}
						}).addTo(map);
						centerMap(isoLayer.getBounds());
					}
				},
				error: function(request) {
					if(request.statusText != "abort") {
						alert(baseErrorMsg + "Error retrieving isochrone results, please try your request again.");
						console.log(request);
					}
				}
			});
		};

		var tabs = true;
		$('#hideButton').on('click', function() {
			if(tabs) {
				$('#tabWrapper').animate({
					left: -425
				}, 425, "swing", function() {
					$('#hideButton').prop('title', 'Expand side panel');
					$('#hideButton span').removeClass('glyphicon-chevron-left');
					$('#hideButton span').addClass('glyphicon-chevron-right');
					tabs = false;
					map.invalidateSize();
				});
			} else {
				$('#tabWrapper').animate({
					left: 0
				}, 425, "swing", function() {
					$('#hideButton').prop('title', 'Collapse side panel');
					$('#hideButton span').removeClass('glyphicon-chevron-right');
					$('#hideButton span').addClass('glyphicon-chevron-left');
					tabs = true;
					map.invalidateSize();
				});
			}
		});

		function isCoords(input) {
			var matches = input.match(/^\s*(-?\d{1,3}(?:\.\d*)?)\s*,\s*(-?[0-9]{1,3}(?:\.\d*)?)\s*$/);
			if(matches != null) {
				var lat = matches[1];
				var lng = matches[2];
				if(lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
					return new L.latLng(lat,lng);
				}
			}
			return false;
		}

		// Random Address event handler
		function randomAddress($field, locationDescriptor, callback, $statusDiv = null, retries = 0) {
			if($statusDiv) {
				$statusDiv.html('Jumping to random civic address...');
			}

			// random lat
			var bounds = map.getBounds();
			var north = Math.min(bounds.getNorth(), 60)
			var south = Math.max(bounds.getSouth(), 48.3)
			var height = north - south;
			var lat = (Math.random() * height * 0.8) + south + (height * 0.1);

			// random lng
			var west = bounds.getWest();
			if(tabs) {
				var west = map.containerPointToLatLng([400,0]).lng;
			}
			west = Math.max(west, -139.06);
			var east = Math.min(bounds.getEast(), -114.03);
			var width = east - west;
			var lng = (Math.random() * width * 0.8) + west + (width * 0.1);

			$.ajax({
				url: gcApi + "sites/nearest.json",
				data: {
					locationDescriptor: locationDescriptor,
					maxDistance: xmdx,
					excludeUnits: true,
					onlyCivic: true,
					brief: true,
					point: lng + "," + lat
				},
				success: function(data) {
					if($statusDiv) {
						$statusDiv.empty();
					}
					$field.val(data.properties.fullAddress);
					return callback(data, $field);
				},
				error: function(request) {
					if(retries < 100) {
						randomAddress($field, locationDescriptor, callback, $statusDiv, retries+1);
					} else {
						if($statusDiv) {
							$statusDiv.empty();
						}
						alert(baseErrorMsg + "Error retrieving nearest site to random point, please try your request again.");
						console.log(request);
					}
				}
			});
		}

		function latLngToLayer(latLng, markerOptions) {
			var marker = L.marker(latLng, markerOptions);
			marker.bindPopup('<span class="popup-title">' + latLng.lat + "," + latLng.lng + '</span>');
			var layer = L.featureGroup([marker]);
			return layer;
		}

		function centerMap(bounds, center = true) {
			var options = {
				maxZoom: 16
			};
			if(tabs) {
				options.paddingTopLeft = [400,0];
			}
			if(center) {
				map.fitBounds(bounds.pad(0.25), options);
			} else if(!map.getBounds().contains(bounds.pad(0.25))) {
				// if the bounds aren't within the current map bounds
				// zoom out to include the bounds
				map.fitBounds(bounds.extend(map.getBounds()).pad(0.25), options);
			}
		}
		function date2String(date) {
			var tzOffset = -(date.getTimezoneOffset());
			return date.getFullYear() + '-'
				+ (date.getMonth()+1).toString().padStart(2, '0') + '-'
				+ (date.getDate()).toString().padStart(2, '0') + 'T'
				+ (date.getHours()).toString().padStart(2, '0') + ':'
				+ (date.getMinutes()).toString().padStart(2, '0') + ':'
				+ '00' + (tzOffset < 0 ? '-' : '+')
				+ Math.abs(tzOffset / 60).toString().padStart(2, '0') + ':'
				+ (tzOffset % 60).toString().padStart(2, '0');
		}

		function buildXingCostString() {
			return $('#yieldCost').val() + ","
					+ $('#signCost').val() + ","
					+ $('#lightCost').val() + ","
					+ $('#multiplier').val();
		}

		function buildGdfString() {
			var s = "";
			$('input.gdf').each( function() {
				s += $(this).prop('id') + ":" + $(this).val() + ",";
			});
			return s;
		}

		function updateConfigString() {
			var s = "globalDistortionField=" + buildGdfString()
					+ "&xingCost=" + buildXingCostString()
					+ "&turnCost=" + $('#leftTurnCost').val() + "," + $('#rightTurnCost').val() + ","
					+ $('#leftTruckTurnCost').val() + "," + $('#rightTruckTurnCost').val();
			$('#configString').val(s);
		}

		if(queryParams['q']) {
			$('#geocodeField').val(queryParams['q']);
			geocode($('#geocodeField'), receiveGeocode);
		}
	</script>
</body>
</html>
